---
title: 刷页的时机
toc: true
thumbnail: /images/
date: 2019-02-08 11:09:57
author:
tags:
---

一条SQL语句，正常执行时候特别快，有时候会突然变得特别慢，而且很难复现，它不只是随机而且持续时间很短。 看上去像数据库抖了一下 -- 原因就是MySQL在刷脏页到磁盘。
<!--more-->
当内存数据页和磁盘数据页内容不一致的时候，这个数据页被称为“脏页”。内存数据写入磁盘后，内存和磁盘的数据页的内容就一致了，称为“干净页”。 不论脏页还是干净页，都存在内存里。

# 触发数据库的刷脏页时机
1. InnoDB的redo log写满了。这时候系统会停止所有更新操作去刷盘。这种情况应该尽量避免，因为出现这种情况的时候，整个系统就不能再接受更新，所有更新呗堵住。

2. 内存不足。当需要新的内存页，内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的是“脏页”，就要将脏页写到磁盘。

InnoDB用缓冲池buffer pool来管理内存，缓冲池中的内存页有三种状态：
1. 还没使用
2. 使用了并且是干净页
3. 使用了并且是脏页
InnoDB的策略是尽量使用内存，因此对于一个长时间运行的库来说，未被使用的页面很少。当要读入的数据页没有在内存的时候，就必须到缓冲池中申请一个数据页。这时候只能把最久不使用的数据页从内存中淘汰掉：如果要淘汰的是一个干净页，就直接释放出来复用；当如果是脏页，就必须先讲脏页刷盘，变成干净页后才能复用。所以刷脏页是常态。

但是出现以下情况会明显影响性能：
- 一个查询要淘汰的脏页个数太多，就会导致查询的响应事件明显变长。
- 日志写满，更新全部堵住，写性能跌为0，这种对于敏感业务来说，是不能接受的。

3. 系统空闲时候。
4. MySQL正常关闭时候。

## 刷盘策略
InnoDB 需要有控制脏页比例的机制，来尽量避免性能的影响。

1. 设置InnoDB所在主机的IO能力，这样InnoDB可以获知全力刷脏页可以多快。
```
innodb_io_capacity = IOPS
```
case: 如果出现MySQL写入速度很慢，TPS很低，而数据库主机IO压力并不大，很可能就是这个原因。

2. InnoDB控制引擎按照“全力”的百分比刷脏页 - 刷盘速度。
刷盘速度主要参考：一个是脏页比例，一个是 redo log 写盘速度。

```
innodb_max_dirty_pages_pct 是脏页比例上限。默认值75%
```













## 参考
https://time.geekbang.org/column/article/71806
